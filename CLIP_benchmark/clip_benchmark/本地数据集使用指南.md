# ğŸ“¦ æœ¬åœ° WebDataset ä½¿ç”¨æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•ä½¿ç”¨å·²ä¸‹è½½çš„æœ¬åœ° WebDataset è¿›è¡Œ Zero-Shot è¯„ä¼°ã€‚

---

## ğŸ“ æ•°æ®é›†ä½ç½®

```
~/data/KeyToken/datasets/webdatasets/
â”œâ”€â”€ cifar10/
â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â”œâ”€â”€ 0.tar      # WebDataset æ ¼å¼ï¼Œæ— éœ€è§£å‹
â”‚   â”‚   â”œâ”€â”€ 1.tar
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ classnames.txt
â”‚   â””â”€â”€ zeroshot_classification_templates.txt
â”œâ”€â”€ cifar100/
â”œâ”€â”€ stl10/
â”œâ”€â”€ caltech101/
â”œâ”€â”€ pets/
â”œâ”€â”€ flowers/
â”œâ”€â”€ dtd/
â”œâ”€â”€ eurosat/
â”œâ”€â”€ fgvc_aircraft/
â”œâ”€â”€ cars/
â”œâ”€â”€ pcam/
â”œâ”€â”€ imagenet_r/
â””â”€â”€ imagenet_sketch/
```

**é‡è¦**ï¼š
- âœ… `.tar` æ–‡ä»¶æ˜¯ WebDataset æ ¼å¼ï¼Œ**æ— éœ€æ‰‹åŠ¨è§£å‹**
- âœ… CLIP Benchmark ä¼šè‡ªåŠ¨è¯»å– `.tar` æ–‡ä»¶ä¸­çš„æ•°æ®
- âœ… æ–‡ä»¶å¯èƒ½æ˜¯ç¬¦å·é“¾æ¥ï¼ˆæŒ‡å‘ HuggingFace ç¼“å­˜ï¼‰ï¼Œè¿™æ˜¯æ­£å¸¸çš„

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### æµ‹è¯•æœ¬åœ°æ•°æ®é›†æ˜¯å¦æ­£å¸¸å·¥ä½œ

```bash
cd ~/data/KeyToken/CLIP_benchmark

# å¿«é€Ÿæµ‹è¯•ï¼ˆCIFAR-10ï¼Œ100 ä¸ªæ ·æœ¬ï¼‰
./bash/test_local_dataset.sh
```

**é¢„æœŸè¾“å‡º**ï¼š
- âœ… æ•°æ®é›†åŠ è½½æˆåŠŸ
- âœ… æ¨¡å‹è¯„ä¼°å®Œæˆ
- âœ… ç”Ÿæˆ JSON ç»“æœæ–‡ä»¶

---

## ğŸ“Š å®Œæ•´è¯„ä¼°

### 1. å¹²å‡€æ ·æœ¬è¯„ä¼°ï¼ˆæ‰€æœ‰ 13 ä¸ªæ•°æ®é›†ï¼‰

```bash
cd ~/data/KeyToken/CLIP_benchmark

# è¯„ä¼° OpenAI CLIP å’Œ FAREÂ² æ¨¡å‹
./bash/eval_local_clean.sh
```

**é…ç½®**ï¼ˆå¯åœ¨è„šæœ¬ä¸­ä¿®æ”¹ï¼‰ï¼š
- æ ·æœ¬æ•°: `SAMPLES=1000` (æ¯ä¸ªæ•°æ®é›†)
- Batch Size: `BS=128`
- è¾“å‡º: `~/data/KeyToken/zero_shot_results/clean/`

**é¢„è®¡æ—¶é—´**: 20-30 åˆ†é’Ÿ

---

### 2. å¯¹æŠ—æ ·æœ¬è¯„ä¼°

```bash
cd ~/data/KeyToken/CLIP_benchmark

# ä½¿ç”¨ AutoAttack (Îµ=2/255)
./bash/eval_local_adv.sh
```

**é…ç½®**ï¼ˆå¯åœ¨è„šæœ¬ä¸­ä¿®æ”¹ï¼‰ï¼š
- æ”»å‡»ç±»å‹: `ATTACK=aa` (AutoAttack)
- æ‰°åŠ¨å¼ºåº¦: `EPS=2` (2/255)
- æ ·æœ¬æ•°: `SAMPLES=1000`
- Batch Size: `BS=128`
- è¾“å‡º: `~/data/KeyToken/zero_shot_results/adversarial/`

**é¢„è®¡æ—¶é—´**: 40-60 åˆ†é’Ÿ

---

## âš™ï¸ è‡ªå®šä¹‰è¯„ä¼°

### è¯„ä¼°ç‰¹å®šæ•°æ®é›†

ç¼–è¾‘ `benchmark/datasets_test.txt`ï¼š
```
cifar10
cifar100
imagenet_r
```

ç„¶åä¿®æ”¹è„šæœ¬ä½¿ç”¨æµ‹è¯•åˆ—è¡¨ï¼š
```bash
# ç¼–è¾‘ eval_local_clean.sh
DATASET_FILE=benchmark/datasets_test.txt
```

### è¯„ä¼°ç‰¹å®šæ¨¡å‹

ç¼–è¾‘ `benchmark/models_local.txt`ï¼š
```
# æ ¼å¼: architecture,pretrained_weights

# OpenAI CLIP
ViT-L-14,openai

# FAREÂ² (Îµ=2)
ViT-L-14,~/data/KeyToken/models/fare_eps_2.pt

# FAREÂ² (Îµ=4)
ViT-L-14,~/data/KeyToken/models/fare_eps_4.pt
```

### è°ƒæ•´è¯„ä¼°å‚æ•°

åœ¨è„šæœ¬ä¸­ä¿®æ”¹ï¼š
```bash
SAMPLES=1000   # -1 = å…¨éƒ¨æ ·æœ¬
BS=128         # Batch size (æ ¹æ® GPU å†…å­˜è°ƒæ•´)
EPS=2          # å¯¹æŠ—æ‰°åŠ¨å¼ºåº¦
```

---

## ğŸ“ˆ æŸ¥çœ‹ç»“æœ

### ç»“æœæ–‡ä»¶ä½ç½®

```
~/data/KeyToken/zero_shot_results/
â”œâ”€â”€ clean/
â”‚   â””â”€â”€ clean_ViT-L-14_openai_cifar10_1000_bs128.json
â””â”€â”€ adversarial/
    â””â”€â”€ adv_ViT-L-14_fare_eps_2_cifar10_1000_bs128_aa_eps2.json
```

### æŸ¥çœ‹å•ä¸ªç»“æœ

```bash
# æŸ¥çœ‹ JSON ç»“æœ
cat ~/data/KeyToken/zero_shot_results/clean/clean_ViT-L-14_openai_cifar10_1000_bs128.json | jq

# æå–å‡†ç¡®ç‡
cat result.json | jq '.metrics.acc1'
```

### ç”Ÿæˆæ±‡æ€»è¡¨æ ¼

```bash
cd ~/data/KeyToken/CLIP_benchmark

# å°†æ‰€æœ‰ JSON ç»“æœåˆå¹¶ä¸º CSV
python -m clip_benchmark.cli build \
  ~/data/KeyToken/zero_shot_results/clean/*.json \
  ~/data/KeyToken/zero_shot_results/adversarial/*.json \
  --output results_summary.csv
```

---

## ğŸ”§ é…ç½®æ–‡ä»¶è¯´æ˜

### æ•°æ®é›†åˆ—è¡¨

**æ–‡ä»¶**: `benchmark/datasets_local.txt`

```
cifar10
cifar100
stl10
caltech101
pets
flowers
dtd
eurosat
fgvc_aircraft
cars
pcam
imagenet_r
imagenet_sketch
```

### æ¨¡å‹åˆ—è¡¨

**æ–‡ä»¶**: `benchmark/models_local.txt`

```
ViT-L-14,openai
ViT-L-14,~/data/KeyToken/models/fare_eps_2.pt
```

æ ¼å¼ï¼š`{architecture},{pretrained_weights}`

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: `.tar` æ–‡ä»¶éœ€è¦è§£å‹å—ï¼Ÿ

**A**: ä¸éœ€è¦ï¼WebDataset æ ¼å¼çš„ `.tar` æ–‡ä»¶ä¼šè¢« CLIP Benchmark è‡ªåŠ¨è¯»å–ã€‚

### Q: ç¬¦å·é“¾æ¥æ˜¯ä»€ä¹ˆï¼Ÿ

**A**: ä¸ºäº†èŠ‚çœç©ºé—´ï¼Œä¸‹è½½çš„æ–‡ä»¶å®é™…å­˜å‚¨åœ¨ `~/.cache/huggingface/` ä¸­ï¼Œæ•°æ®é›†ç›®å½•ä¸­çš„æ˜¯ç¬¦å·é“¾æ¥ã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸å½±å“ä½¿ç”¨ã€‚

### Q: å¦‚ä½•éªŒè¯æ•°æ®é›†å®Œæ•´æ€§ï¼Ÿ

**A**: è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼š
```bash
cd ~/data/KeyToken/CLIP_benchmark
./bash/test_local_dataset.sh
```

### Q: è¯„ä¼°å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ

**A**: è°ƒæ•´å‚æ•°ï¼š
- å‡å°‘æ ·æœ¬æ•°ï¼š`SAMPLES=500`
- å¢åŠ  Batch Sizeï¼š`BS=256` (å¦‚æœ GPU å†…å­˜å¤Ÿå¤§)
- åªè¯„ä¼°æ ¸å¿ƒæ•°æ®é›†ï¼šä½¿ç”¨ `datasets_test.txt`

### Q: GPU å†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

**A**: å‡å° Batch Sizeï¼š
```bash
BS=64   # æˆ–æ›´å°
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½ï¼ˆå‚è€ƒï¼‰

| æ¨¡å‹ | CIFAR-10 | CIFAR-100 | ImageNet-R | å¹³å‡ |
|------|----------|-----------|------------|------|
| OpenAI CLIP | ~94% | ~76% | ~73% | ~81% |
| FAREÂ² (Îµ=2) | ~92% | ~74% | ~71% | ~79% |

**å¯¹æŠ—é²æ£’æ€§**ï¼ˆÎµ=2/255ï¼‰ï¼š
| æ¨¡å‹ | CIFAR-10 | CIFAR-100 | ImageNet-R |
|------|----------|-----------|------------|
| OpenAI CLIP | ~45% | ~30% | ~28% |
| FAREÂ² (Îµ=2) | ~78% | ~62% | ~58% |

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. âœ… **æµ‹è¯•**: è¿è¡Œ `./bash/test_local_dataset.sh`
2. âœ… **å¹²å‡€è¯„ä¼°**: è¿è¡Œ `./bash/eval_local_clean.sh`
3. âœ… **å¯¹æŠ—è¯„ä¼°**: è¿è¡Œ `./bash/eval_local_adv.sh`
4. âœ… **åˆ†æç»“æœ**: ç”Ÿæˆ CSV æ±‡æ€»

---

**æ€»ç»“**: ä½¿ç”¨æœ¬åœ° WebDataset æ— éœ€ä»»ä½•é¢å¤–å¤„ç†ï¼Œç›´æ¥è¿è¡Œè¯„ä¼°è„šæœ¬å³å¯ï¼
