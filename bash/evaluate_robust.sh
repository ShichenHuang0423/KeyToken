#!/bin/bash
# ============================================================================
# ç»Ÿä¸€çš„é²æ£’æ€§è¯„ä¼°è„šæœ¬
# ä½¿ç”¨è®ºæ–‡è®¾ç½®: APGD-CE + APGD-DLR (targeted), å„100è¿­ä»£
# ============================================================================
#
# ã€æ¨ç†æ¨¡å¼è¯´æ˜ã€‘
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ æ¨¡å¼     â”‚ è¯´æ˜                                                       â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ baseline â”‚ æ ‡å‡†CLIPæ¨ç†ï¼Œä¸ä½¿ç”¨ä»»ä½•å¢å¼ºæ¨¡å—                            â”‚
# â”‚          â”‚ é€‚ç”¨äº: FARE, TeCoA, OpenAI CLIP, Stage0ç­‰åŸºçº¿æ¨¡å‹          â”‚
# â”‚          â”‚ å¯¹äºStage1æƒé‡ä¹Ÿå¯ç”¨ï¼Œæ­¤æ—¶ä»…åŠ è½½CLIP backboneæƒé‡           â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ eval     â”‚ å¢å¼ºæ¨¡å‹ + å®Œæ•´é˜²å¾¡æœºåˆ¶                                     â”‚
# â”‚          â”‚ åŒ…å«: æ‰°åŠ¨æ£€æµ‹ â†’ å…³é”®Tokenç­›é€‰ â†’ Tokenè¿‡æ»¤ â†’ ç‰¹å¾èåˆ       â”‚
# â”‚          â”‚ é€‚ç”¨äº: ä½¿ç”¨EnhancedClipVisionModelè®­ç»ƒçš„checkpoint         â”‚
# â”‚          â”‚ è¿™æ˜¯é˜²å¾¡æ¨¡å¼ï¼Œç”¨äºæµ‹è¯•å¢å¼ºæ¨¡å—çš„é˜²å¾¡æ•ˆæœ                    â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ attack   â”‚ å¢å¼ºæ¨¡å‹ + æ— é˜²å¾¡ï¼ˆä»…ä½¿ç”¨è®­ç»ƒåçš„backboneï¼‰                 â”‚
# â”‚          â”‚ è·³è¿‡æ‰€æœ‰é˜²å¾¡æ¨¡å—ï¼Œç›´æ¥ä½¿ç”¨è§†è§‰ç¼–ç å™¨è¾“å‡º                    â”‚
# â”‚          â”‚ é€‚ç”¨äº: å¯¹æ¯”æµ‹è¯•ï¼Œè¯„ä¼°backboneæœ¬èº«çš„é²æ£’æ€§                  â”‚
# â”‚          â”‚ ä¸evalå¯¹æ¯”å¯é‡åŒ–å¢å¼ºæ¨¡å—çš„é˜²å¾¡è´¡çŒ®                          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ã€ç”¨æ³•ã€‘
#   ç›´æ¥ç¼–è¾‘ä¸‹æ–¹çš„ EVAL_TASKS æ•°ç»„ï¼Œç„¶åè¿è¡Œ:
#   bash bash/evaluate_robust.sh
#
# ============================================================================

set -e

# è®¾ç½®GPUï¼ˆå¿…é¡»åœ¨æ¿€æ´»condaä¹‹å‰ï¼‰
export CUDA_VISIBLE_DEVICES=4,5,6,7

# æ¿€æ´»condaç¯å¢ƒ
source ~/miniconda3/etc/profile.d/conda.sh
conda activate keytoken

# ============================================================================
# å…¨å±€é…ç½®
# ============================================================================
IMAGENET_ROOT="/home/ubuntu/data/KeyToken/datasets/imagenet"
OUTPUT_DIR="output/robust_eval"
BATCH_SIZE=64  # 4GPUå¹¶è¡Œï¼Œå¯ä½¿ç”¨è¾ƒå¤§batch
ITERATIONS=100  # è®ºæ–‡è®¾ç½®: APGD 100è¿­ä»£
EPS=4           # æ‰°åŠ¨åŠå¾„: 4/255
GPU_ID="4,5,6,7"  # æ³¨æ„ï¼šCUDA_VISIBLE_DEVICESå·²è®¾ç½®ä¸º4567ï¼ŒPyTorchçœ‹åˆ°çš„æ˜¯ç›¸å¯¹ID 0123
MAX_SAMPLES=-1  # è¯„ä¼°æ ·æœ¬æ•°ï¼Œ-1ä¸ºå…¨é‡50000

# ============================================================================
# è¯„ä¼°ä»»åŠ¡é…ç½®
# æ ¼å¼: "ä»»åŠ¡åç§°|æƒé‡è·¯å¾„|æ¨ç†æ¨¡å¼|ensemble_size|max_samples|noise_std|gray_box|randomize_defense"
# æ¨ç†æ¨¡å¼: baseline / eval / attack
# ensemble_size: 1=å•æ¬¡ï¼Œ3-5=é›†æˆé˜²å¾¡ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
# max_samples: æ ·æœ¬æ•°ï¼Œ-1=å…¨é‡50000ï¼ˆå¯é€‰ï¼Œé»˜è®¤-1ï¼‰
# noise_std: éšæœºå™ªå£°æ ‡å‡†å·®ï¼Œ0=ç¡®å®šæ€§ï¼Œ0.01-0.02=æ¨èï¼ˆå¯é€‰ï¼Œé»˜è®¤0.01ï¼‰
# gray_box: 0=ç™½ç›’ï¼ˆAPGDçŸ¥é“é˜²å¾¡ï¼‰ï¼Œ1=ç°ç›’ï¼ˆAPGDåªæ”»å‡»backboneï¼‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰
# randomize_defense: 0=ç¡®å®šæ€§é˜²å¾¡ï¼Œ1=å†…ç½®éšæœºåŒ–é˜²å¾¡é“¾ï¼ˆæ‰“ç ´APGDæ¢¯åº¦ï¼‰ï¼ˆå¯é€‰ï¼Œé»˜è®¤0ï¼‰
# ============================================================================
EVAL_TASKS=(
    # --- ç°ç›’ + å†…ç½®éšæœºåŒ–é˜²å¾¡é“¾ï¼ˆæœ€å¼ºé˜²å¾¡ï¼‰---
    # å•æ¬¡å‰å‘ + éšæœºåŒ–é˜²å¾¡é“¾ï¼šæ¯æ¬¡å‰å‘ä¼ æ’­é˜²å¾¡è¡Œä¸ºéƒ½ä¸åŒ
    "E4_rand_defense|models/stage0_epoch4.pt|eval|1|-1|0|1|1"
    "E4_rand_defense_ensemble|models/stage0_epoch4.pt|eval|3|-1|0.01|1|1"
    # --- å¯¹æ¯”æµ‹è¯•ï¼šç¡®å®šæ€§ vs éšæœºåŒ– ---
    # "E4_graybox_baseline|models/stage0_epoch4.pt|eval|1|-1|0|1|0"  # ç¡®å®šæ€§é˜²å¾¡
    # "E4_rand_5k|models/stage0_epoch4.pt|eval|1|5000|0|1|1"  # å¿«é€ŸéªŒè¯
)

# ============================================================================
# è¯„ä¼°å‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
# ============================================================================
evaluate_model() {
    local name=$1
    local checkpoint=$2
    local mode=$3
    local ensemble_size=${4:-1}      # é»˜è®¤1
    local max_samples=${5:--1}       # é»˜è®¤-1ï¼ˆå…¨é‡ï¼‰
    local noise_std=${6:-0.01}       # é»˜è®¤0.01
    local gray_box=${7:-0}           # é»˜è®¤0ï¼ˆç™½ç›’ï¼‰
    local randomize_defense=${8:-0}  # é»˜è®¤0ï¼ˆç¡®å®šæ€§ï¼‰
    
    echo ""
    echo "=========================================="
    echo "ğŸ“Š è¯„ä¼°: ${name}"
    echo "   æƒé‡: ${checkpoint}"
    echo "   æ¨¡å¼: ${mode}"
    echo "   æ ·æœ¬æ•°: ${max_samples}"
    if [ $ensemble_size -gt 1 ]; then
        if (( $(echo "$noise_std > 0" | bc -l) )); then
            echo "   ğŸ¯ éšæœºåŒ–Ensemble: ${ensemble_size}æ¬¡é‡‡æ · (noise_std=${noise_std})"
        else
            echo "   ğŸ¯ ç¡®å®šæ€§Ensemble: ${ensemble_size}æ¬¡é‡‡æ ·"
        fi
    fi
    if [ $gray_box -eq 1 ]; then
        echo "   ğŸ”’ ç°ç›’æ”»å‡»: APGDåªæ”»å‡»backboneï¼ˆä¸çŸ¥é“é˜²å¾¡ç­–ç•¥ï¼‰"
    fi
    if [ $randomize_defense -eq 1 ]; then
        echo "   ğŸ² å†…ç½®éšæœºåŒ–é˜²å¾¡é“¾: é˜ˆå€¼/ä¸Šä¸‹æ–‡/èåˆæƒé‡éšæœºåŒ–ï¼ˆæ‰“ç ´APGDæ¢¯åº¦ï¼‰"
    fi
    echo "=========================================="
    
    if [ -f "$checkpoint" ]; then
        # æ„å»ºå‚æ•°æ•°ç»„
        local args=(
            python tools/evaluate_robust.py
            --clip_model_name ViT-L-14
            --pretrained "$checkpoint"
            --mode "$mode"
            --imagenet_root "$IMAGENET_ROOT"
            --batch_size "$BATCH_SIZE"
            --max_samples "$max_samples"
            --eps "$EPS"
            --iterations "$ITERATIONS"
            --ensemble_size "$ensemble_size"
            --noise_std "$noise_std"
            --output_dir "$OUTPUT_DIR"
        )
        
        # æ·»åŠ å¯é€‰å‚æ•°
        if [ $gray_box -eq 1 ]; then
            args+=(--gray_box)
        fi
        
        if [ $randomize_defense -eq 1 ]; then
            args+=(--randomize_defense)
        fi
        
        # æ‰§è¡Œå‘½ä»¤
        "${args[@]}"
    else
        echo "âš ï¸  è­¦å‘Š: $checkpoint ä¸å­˜åœ¨ï¼Œè·³è¿‡"
    fi
}

# ============================================================================
# ä¸»ç¨‹åº
# ============================================================================
mkdir -p $OUTPUT_DIR

echo "=========================================="
echo "ğŸ”¬ é²æ£’æ€§è¯„ä¼° (è®ºæ–‡è®¾ç½®)"
echo "=========================================="
echo "æ”»å‡»: AutoAttack (APGD-CE + APGD-DLR targeted)"
echo "è¿­ä»£: ${ITERATIONS}"
echo "æ‰°åŠ¨: eps=${EPS}/255"
echo "æ ·æœ¬: ${MAX_SAMPLES}"
echo "GPU: ${GPU_ID}"
echo "ä»»åŠ¡æ•°: ${#EVAL_TASKS[@]}"
echo "=========================================="

# æ‰§è¡Œæ‰€æœ‰è¯„ä¼°ä»»åŠ¡
for task in "${EVAL_TASKS[@]}"; do
    IFS='|' read -r name checkpoint mode ensemble_size max_samples noise_std gray_box randomize_defense <<< "$task"
    evaluate_model "$name" "$checkpoint" "$mode" "$ensemble_size" "$max_samples" "$noise_std" "$gray_box" "$randomize_defense"
done

# æ±‡æ€»ç»“æœ
echo ""
echo "=========================================="
echo "ğŸ“‹ è¯„ä¼°ç»“æœæ±‡æ€»"
echo "=========================================="

if ls $OUTPUT_DIR/*_results.txt 1> /dev/null 2>&1; then
    for f in $OUTPUT_DIR/*_results.txt; do
        echo ""
        echo "--- $(basename $f) ---"
        cat "$f"
    done
else
    echo "æš‚æ— ç»“æœæ–‡ä»¶"
fi

echo ""
echo "=========================================="
echo "âœ… è¯„ä¼°å®Œæˆ!"
echo "ç»“æœä¿å­˜åœ¨: $OUTPUT_DIR"
echo "=========================================="
